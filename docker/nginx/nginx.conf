server {
    listen 80;
    index index.php;
    gzip on;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    add_header keep-alive "timeout=10, max=1000";
    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/webroot;
    set_real_ip_from 0.0.0.0/24;
    real_ip_header X-Forwarded-For;
    client_max_body_size 0;
    proxy_send_timeout 3600;
    proxy_read_timeout 3600;
    fastcgi_send_timeout 3600;
    fastcgi_read_timeout 3600;
    
    # Bloquear acesso a diretórios sensíveis
    location ~* /(config|logs|vendor|tests|node_modules|docker|scripts|src)/ {
        return 403;
    }
    
    # Bloquear acesso a arquivos de configuração
    location ~* /(composer\.(json|lock)|\.env.*|\.git.*|package\.(json|lock)|yarn\.lock)$ {
        return 403;
    }
    
    # Bloquear acesso a arquivos sensíveis
    location ~* \.(htaccess|htpasswd|log|ini|json|lock|sh|bak|old|swp|sql|md)$ {
        return 403;
    }

    # Atender requests com prefixo /public/ (strip /public/ -> serve from /var/www/public)
    location ^~ /public/ {
        alias /var/www/public/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri $uri/ =404;
    }

    # Atender requests com prefixo /webroot/ (strip /webroot/ -> serve from /var/www/webroot)
    location ^~ /webroot/ {
        alias /var/www/webroot/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri $uri/ =404;
    }

    # Servir arquivos estáticos das pastas permitidas
    location ~* ^/(css|js|images|img|assets|fonts)/.*\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|mp4|mp3|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
	
    location / {
        add_header Access-Control-Allow-Origin "http://localhost:8000" always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Headers "Authorization,Accept,Origin,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type" always;
        add_header Access-Control-Allow-Methods "GET,POST,OPTIONS,PUT,DELETE,PATCH" always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
        try_files $uri $uri/ /index.php?$query_string;
    }
	
    location ^~ /Api/ {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
            add_header 'Content-Type' 'text/plain charset=UTF-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
        rewrite ^/Api/(.*)$ /index.php?url=Api/$1 last;
    }

    # Endpoint direto /api mapeado para /var/www/index.php (backend CEP)
    location = /api {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
            add_header 'Content-Type' 'text/plain charset=UTF-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;

        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/index.php;
    }

    # Versão minúscula /api para facilitar consumo pela aplicação frontend
    # Pega tanto /api quanto /api/alguma-coisa
    location ^~ /api {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
            add_header 'Content-Type' 'text/plain charset=UTF-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
        # Mantém a mesma rota interna, ainda usando "Api" para o PHP
        rewrite ^/api/?(.*)$ /index.php?url=Api/$1 last;
    }
	
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
    }
}

server {
    listen 443 ssl http2;
    index index.php;
    gzip on;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    add_header keep-alive "timeout=10, max=1000";
    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/webroot;
    set_real_ip_from 0.0.0.0/24;
    real_ip_header X-Forwarded-For;
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2;
    client_max_body_size 0;
    proxy_send_timeout 3600;
    proxy_read_timeout 3600;
    fastcgi_send_timeout 3600;
    fastcgi_read_timeout 3600;
    
    # Bloquear acesso a diretórios sensíveis
    location ~* /(config|logs|vendor|tests|node_modules|docker|scripts|src)/ {
        return 403;
    }
    
    # Bloquear acesso a arquivos de configuração
    location ~* /(composer\.(json|lock)|\.env.*|\.git.*|package\.(json|lock)|yarn\.lock)$ {
        return 403;
    }
    
    # Bloquear acesso a arquivos sensíveis
    location ~* \.(htaccess|htpasswd|log|ini|json|lock|sh|bak|old|swp|sql|md)$ {
        return 403;
    }

    # Atender requests com prefixo /public/ (strip /public/ -> serve from /var/www/public)
    location ^~ /public/ {
        alias /var/www/public/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri $uri/ =404;
    }

    # Atender requests com prefixo /webroot/ (strip /webroot/ -> serve from /var/www/webroot)
    location ^~ /webroot/ {
        alias /var/www/webroot/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri $uri/ =404;
    }

    # Servir arquivos estáticos das pastas permitidas
    location ~* ^/(css|js|images|img|assets|fonts)/.*\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|mp4|mp3|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
	
    location / {
        add_header Access-Control-Allow-Origin "http://localhost:8000" always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Headers "Authorization,Accept,Origin,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type" always;
        add_header Access-Control-Allow-Methods "GET,POST,OPTIONS,PUT,DELETE,PATCH" always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
        try_files $uri $uri/ /index.php?$query_string;
    }
	
    location ^~ /Api/ {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
            add_header 'Content-Type' 'text/plain charset=UTF-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
        rewrite ^/Api/(.*)$ /index.php?url=Api/$1 last;
    }

    # Endpoint direto /api mapeado para /var/www/index.php (backend CEP)
    location = /api {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
            add_header 'Content-Type' 'text/plain charset=UTF-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;

        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/index.php;
    }

    # Versão minúscula /api para facilitar consumo pela aplicação frontend
    # Pega tanto /api quanto /api/alguma-coisa
    location ^~ /api {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
            add_header 'Content-Type' 'text/plain charset=UTF-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
        # Mantém a mesma rota interna, ainda usando "Api" para o PHP
        rewrite ^/api/?(.*)$ /index.php?url=Api/$1 last;
    }
	
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass 172.18.0.3:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Accept, Origin, DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;
    }
}
